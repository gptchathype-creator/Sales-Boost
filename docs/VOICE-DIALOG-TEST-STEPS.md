# Пошаговая настройка и тест голосового диалога (ASR → нейрон → TTS)

Полный чеклист: что вставить в Voximplant, как запустить серверы, какой URL указать, как позвонить.

---

## Шаг 1. Создать сценарий в Voximplant

1. Зайдите в [личный кабинет Voximplant](https://manage.voximplant.com/).
2. Выберите приложение (то же, где уже есть сценарий `smoke_test`).
3. Откройте **Scenarios** и нажмите **Add scenario** (или **+**).
4. **Имя сценария:** `voice_dialog` (или другое — тогда его нужно будет указать в `.env` в `VOX_DIALOG_SCENARIO_NAME`).
5. В поле кода сценария **полностью замените** содержимое на код из файла в репозитории:
   - **Файл:** `voximplant/scenario_voice_dialog.js`
   - Откройте этот файл в проекте и **скопируйте весь текст** (от первой строки с `// Voximplant scenario...` до последней `});`).
6. Сохраните сценарий (Save / Deploy).

---

## Шаг 2. Создать правило и привязать к нему сценарий voice_dialog

**Важно:** в Voximplant при вызове StartScenarios API передаётся только **имя правила** (rule_name). Какой сценарий запустится, определяет **правило**: к правилу привязан один или несколько сценариев. Поэтому правило `smoke_test_rule` всегда запускает сценарий `smoke_test`. Чтобы запускался диалог, нужно отдельное правило с привязанным сценарием `voice_dialog`.

1. В кабинете Voximplant откройте **Routing** → **Rules**.
2. Создайте **новое правило** (Add rule), имя: **`voice_dialog_rule`** (или другое — тогда укажите его в `.env` в `VOX_DIALOG_RULE_NAME`).
3. К этому правилу **привяжите сценарий** `voice_dialog` (Bind scenario / привязать сценарий). Параметры правила (номера, триггер для исходящих и т.д.) настройте по аналогии с `smoke_test_rule`, чтобы исходящие вызовы через API могли использовать это правило.
4. В **`.env`** укажите: **`VOX_DIALOG_RULE_NAME=voice_dialog_rule`** (или то имя, которое вы дали правилу). Без этой переменной при `dialog: true` будет использоваться `VOX_RULE_NAME` (smoke_test_rule), и снова запустится только smoke_test — одна фраза и отбой.

---

## Шаг 3. Запустить основное приложение (порт 3000)

Из корня проекта:

```bash
npm run dev
```

- Поднимется сервер на **порту 3000** (бот, админка, **POST /voice/dialog**).
- Запустится туннель (localhost.run) на этот же порт.
- **В консоли появится строка с URL туннеля**, например:
  - `[TUNNEL] https://xxxxx.lhr.life`  
  или  
  - `Tunnel URL: https://....`
- **Скопируйте этот URL** (без слеша в конце) — он понадобится на шаге 5.

---

## Шаг 4. Запустить сервер звонков (порт 3001)

Откройте **второй терминал**, из корня проекта:

```bash
npm run call-test:dev
```

- Поднимется vox-smoke-test-server на **порту 3001**.
- Он принимает `POST /call` и шлёт события от Voximplant на `PUBLIC_BASE_URL` (webhooks).

Оба процесса должны работать одновременно: в одном терминале `npm run dev`, в другом — `npm run call-test:dev`.

---

## Шаг 5. Прописать URL в .env (VOICE_DIALOG_BASE_URL)

1. Откройте файл **`.env`** в корне проекта.
2. Найдите переменную **`VOICE_DIALOG_BASE_URL`**.
3. Вставьте **скопированный на шаге 3 URL туннеля** (тот, что выводится в консоли при `npm run dev`), **без слеша в конце**.

Пример:

```env
VOICE_DIALOG_BASE_URL=https://xxxxx.lhr.life
```

4. Сохраните файл.
5. **Перезапустите** сервер звонков (`npm run call-test:dev`): остановите (Ctrl+C) и снова выполните `npm run call-test:dev`, чтобы он подхватил новый `VOICE_DIALOG_BASE_URL`.

Важно: это должен быть именно URL **основного приложения** (туннель на порт 3000), а не `PUBLIC_BASE_URL` (порт 3001). По этому URL Voximplant будет вызывать `POST /voice/dialog`.

---

## Шаг 6. Проверить остальные переменные в .env

Убедитесь, что в `.env` заданы:

- `VOX_ACCOUNT_ID`, `VOX_API_KEY`, `VOX_APP_ID` — как для обычных звонков.
- `VOX_RULE_NAME=smoke_test_rule` — для обычных звонков без диалога (оставьте как есть).
- **`VOX_DIALOG_RULE_NAME=voice_dialog_rule`** — **обязательно для диалога.** Правило, к которому в Voximplant привязан сценарий `voice_dialog`. Без этого при `dialog: true` будет использоваться smoke_test_rule и снова запустится smoke_test.
- `PUBLIC_BASE_URL` — публичный URL сервера на порту 3001 (webhooks).
- `VOX_DIALOG_SCENARIO_NAME=voice_dialog` — имя сценария (если не меняли — оставьте так).
- `VOX_TEST_TO` или `VOX_TEST_NUMBERS` — номер для теста.

---

## Шаг 7. Инициировать звонок с диалогом

Когда оба сервера запущены и `.env` обновлён:

**Вариант A — curl:**

```bash
curl -X POST http://localhost:3001/call \
  -H "Content-Type: application/json" \
  -d '{"dialog": true}'
```

Будет использован номер по умолчанию из `VOX_TEST_TO` (или первый из `VOX_TEST_NUMBERS`).

**Вариант B — указать номер явно:**

```bash
curl -X POST http://localhost:3001/call \
  -H "Content-Type: application/json" \
  -d '{"to": "+79XXXXXXXXX", "dialog": true}'
```

В ответ придёт что-то вроде: `{"call_id":"...", "started_at":"..."}`.

---

## Шаг 8. Что должно произойти при тесте

1. На указанный номер поступит звонок.
2. После ответа прозвучит **первая реплика виртуального клиента** (озвучка через TTS в Voximplant).
3. Включится распознавание речи (ASR). Вы говорите фразу — она уходит на наш бэкенд (`POST /voice/dialog` с текстом), бэкенд возвращает ответ «клиента» → он озвучивается (TTS), и так по кругу.
4. Когда бэкенд вернёт `end_session: true` или звонок завершится иначе — соединение разорвётся.

В логах основного приложения (терминал с `npm run dev`) будут запросы на `POST /voice/dialog`. В логах vox-smoke-test-server — события от Voximplant (progress, connected, disconnected).

---

## Краткая сводка

| Что | Где / как |
|-----|-----------|
| Код сценария | Файл `voximplant/scenario_voice_dialog.js` → скопировать целиком в сценарий в кабинете Voximplant |
| Имя сценария в Vox | `voice_dialog` (или значение `VOX_DIALOG_SCENARIO_NAME` в `.env`) |
| **Правило для диалога** | Создать правило **voice_dialog_rule**, привязать к нему сценарий **voice_dialog**. В `.env`: **`VOX_DIALOG_RULE_NAME=voice_dialog_rule`**. Иначе при `dialog: true` запустится smoke_test. |
| Основное приложение | `npm run dev` (порт 3000, туннель стартует сам) |
| Сервер звонков | `npm run call-test:dev` (порт 3001), второй терминал |
| **VOICE_DIALOG_BASE_URL** | URL туннеля основного приложения из консоли `npm run dev` (без слеша в конце) |
| Запуск звонка с диалогом | `POST http://localhost:3001/call` с телом `{"dialog": true}` (или с `"to": "+79..."`) |

Если что-то не сработает: проверьте, что туннель на 3000 доступен по `VOICE_DIALOG_BASE_URL`, и что в Voximplant выбран сценарий `voice_dialog` и правило маршрутизации его допускает.
