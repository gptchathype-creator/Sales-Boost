# Голосовой звонок с диалогом — что сделать по шагам

## 1. Запустить основное приложение (оно отдаёт ответы «нейрона»)

В **первом терминале** из корня проекта:

```bash
cd "путь/к/Sales-Boost"
npm run dev
```

Дождитесь строки вроде:
- `[TUNNEL] https://xxxx.lhr.life` или
- другого **публичного URL** (туннель).

Скопируйте этот URL (без слеша в конце). Он понадобится в шаге 2.

---

## 2. Прописать URL в .env

Откройте файл **`.env`** в корне проекта.

Найдите строку:

```env
VOICE_DIALOG_BASE_URL=https://9e2071818668a4.lhr.life
```

Замените значение на **тот URL, который показал шаг 1** (из вывода `npm run dev`).  
Если туннель каждый раз новый — после каждого перезапуска `npm run dev` обновляйте эту строку и перезапускайте сервер звонков (шаг 3).

Пример:
```env
VOICE_DIALOG_BASE_URL=https://ваш-туннель.lhr.life
```

Сохраните файл.

---

## 3. Запустить сервер тестовых звонков

Во **втором терминале** из корня проекта:

```bash
cd "путь/к/Sales-Boost"
npm run call-test:dev
```

Оставьте этот терминал открытым. Сервер читает `.env` только при старте — если вы только что поменяли `VOICE_DIALOG_BASE_URL`, он уже подхватит новый URL.

---

## 4. Обновить сценарий в Voximplant

1. Откройте [Voximplant Application Manager](https://manage.voximplant.com/).
2. Выберите приложение → **Scenarios**.
3. Откройте сценарий с именем **voice_dialog** (или создайте его и назовите так).
4. Вставьте в него **весь** код из файла в проекте:
   ```
   voximplant/scenario_voice_dialog.js
   ```
5. Сохраните сценарий.

Убедитесь, что у вас есть **правило маршрутизации** (например, **voice_dialog_rule**), которое привязано к этому сценарию. В `.env` должна быть строка:
```env
VOX_DIALOG_RULE_NAME=voice_dialog_rule
```

---

## 5. Позвонить себе (тест)

В **третьем терминале** или через браузер/Postman:

```bash
curl -X POST http://localhost:3001/call \
  -H "Content-Type: application/json" \
  -d '{"dialog": true}'
```

Либо без указания номера (будет использоваться `VOX_TEST_TO` из `.env`):

```bash
curl -X POST http://localhost:3001/call \
  -H "Content-Type: application/json" \
  -d '{}'
```

Должен прийти ответ с `call_id`. Через несколько секунд на номер из `VOX_TEST_TO` должен поступить звонок.

---

## 6. Проверить, что запросы доходят до приложения

Пока вы говорите в трубку, в **первом терминале** (где запущен `npm run dev`) должны появляться строки:

```
[voice/dialog] Request { call_id: '...', text_preview: '(first)' }
[voice/dialog] Request { call_id: '...', text_preview: 'алло' }
...
```

- Если эти строки **есть** — запросы от Voximplant доходят до вашего приложения, диалог должен работать.
- Если этих строк **нет** — до приложения запросы не доходят. Тогда проверьте:
  - что в `.env` в `VOICE_DIALOG_BASE_URL` указан **тот же** URL, что выводит туннель при `npm run dev`;
  - что туннель не закрыт и приложение запущено на порту 3000.

---

## Краткий чеклист

| Шаг | Действие |
|-----|----------|
| 1 | Запустить `npm run dev`, запомнить URL туннеля |
| 2 | В `.env` прописать этот URL в `VOICE_DIALOG_BASE_URL` |
| 3 | Запустить `npm run call-test:dev` (второй терминал) |
| 4 | В Voximplant обновить сценарий **voice_dialog** кодом из `voximplant/scenario_voice_dialog.js` |
| 5 | Отправить `POST http://localhost:3001/call` с `{"dialog": true}` |
| 6 | Ответить на звонок и проверить в первом терминале логи `[voice/dialog] Request` |

Если что-то не сработает — пришлите вывод из терминала с `npm run dev` (первые 20–30 строк после запуска и строки во время звонка) и, по возможности, скрин или лог из Voximplant по этому звонку.
